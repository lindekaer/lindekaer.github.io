<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="description" content="In this tutorial I will show you how to restrict access to the files you store in a AWS S3 bucket. In order to achieve this, we are going to set up both AWS S3 and AWS CloudFront. Before doing into the implementation I&apos;d like to provide an overview of the problem space and the technologies."><meta name="keywords" content="development, programming, technology, IT, computer, algorithm, tutorial, guide, Docker, Node, Javascript, HTML, CSS"><meta name="author" content="Theodor Lindekaer"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="57x57" href="frontend/dist/images/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="frontend/dist/images/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="frontend/dist/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="frontend/dist/images/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="frontend/dist/images/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="frontend/dist/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="frontend/dist/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="frontend/dist/images/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="frontend/dist/images/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" href="frontend/dist/images/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="frontend/dist/images/android-chrome-192x192.png" sizes="192x192"><link rel="icon" type="image/png" href="frontend/dist/images/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="frontend/dist/images/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="frontend/dist/images/manifest.json"><link rel="mask-icon" href="frontend/dist/images/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="frontend/dist/images/favicon.ico"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-TileImage" content="frontend/dist/images/mstile-144x144.png"><meta name="msapplication-config" content="frontend/dist/images/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:300,+300italic|Lato:900|Source+Code+Pro" media="all"><link rel="stylesheet" href="frontend/dist/styles/dist-vendor.min.css" type="text/css"><link rel="stylesheet" href="frontend/dist/styles/dist.min.css" type="text/css"><title>Serve private content from AWS S3 | Lindekaer</title></head><body class="page-article"><div class="gradient-top"></div><article itemscope="" itemtype="http://schema.org/Article" class="article"><h1 itemprop="headline" class="article__title">Serve private content from AWS S3</h1><div class="article__meta"><div itemprop="author" itemscope="" itemtype="https://schema.org/Person" class="article__meta__author"><span itemprop="name">Theodor Lindekaer</span></div><div class="article__meta__date"><span itemprop="datePublished">November 1st, 2016</span></div></div><main class="article__content"><p>In this tutorial I will show you how to restrict access to the files you store in a AWS S3 bucket. In order to achieve this, we are going to set up both <a href="https://github.com/open-guides/og-aws#s3">AWS S3</a> and <a href="https://github.com/open-guides/og-aws#cloudfront">AWS CloudFront</a>. Before doing into the implementation I&apos;d like to provide an overview of the problem space and the technologies.</p><h2 id="s3-cloudfront-and-signed-urls">S3, CloudFront and signed URLs</h2><p><strong>S3</strong> is a storage solution from Amazon Web Services (AWS) for storing files. These files can be anything from <code>.html</code> (for hosting a static site) to various image and audio formats such as <code>.mp3</code> and <code>.mp4</code>. <strong>CloudFront</strong> is a CDN service that plays well together with other AWS services. Storing files and serving them over CDN is all well and good, but what if I want to enable only authenticated users to be able to download? Additionally, what if I want to restrict the access to, let&apos;s say, 20 seconds?</p><p>An answer to this problem is <em>usage of signed URLs</em>. A signed URL is a URL that been signed by a trusted authority. It is possible to include additional details in the signature such as time to expiry. This means that we can sign a URL pointing to a resource in our S3 bucket and thereby ensure that only authenticated users can access the resource. There is a bit more nuance to the solution, but let&apos;s take a look at the implementation step for step.</p><div class="media"><img class="media__image" data-src="serve-private-content-from-aws-s3.overview.png" title="The system" alt="The system"><p class="media__caption">The system</p></div><h2 id="implementation">Implementation</h2><p>My implementation is mostly based on the AWS Console (web interface), but using the AWS CLI is also a possibility.</p><h3 id="1-create-s3-bucket">1. Create S3 bucket</h3><ul><li>Go to AWS S3</li><li>Click <strong>Create Bucket</strong></li><li>Fill in <strong>Bucket Name</strong> and choose a <strong>Region</strong> suitable for your application</li><li>Click the newly created bucket</li><li>Click <strong>Upload</strong> and upload an image (why not a funny cat?)</li></ul><div class="media"><img class="media__image" data-src="http://i.imgur.com/SzaXL2R.jpg" title="Feel free to use this cat" alt="Feel free to use this cat"><p class="media__caption">Feel free to use this cat</p></div><h3 id="2-create-cloudfront-distribution">2. Create CloudFront distribution</h3><ul><li>Go to AWS CloudFront</li><li>Click <strong>Create Distribution</strong></li><li>Under <em>Web</em> click <strong>Get Started</strong></li><li>Highlight the <strong>Origin Domain Name</strong> and select your S3 bucket from the dropdown</li><li><em>Optional</em>: If your store your files in a nested structure <code>project/assets/images</code> you can specify the path in <strong>Origin Path</strong></li><li>Check <strong>Restrict Bucket Access</strong> (yup, surprise!)</li><li>Check <strong>Create a New Identity</strong></li><li>Check in the <strong>Comment</strong> field write a suitable name (this identity can be reused for other distributions)</li><li>Check <strong>Yes, Update Bucket Policy</strong></li></ul><p>Basically, we have made CloudFront aware of our files&apos; location and created a policy for the S3 bucket that makes it possible for CloudFront to fetch resources from an otherwise <em>private</em> S3 Bucket.</p><ul><li>Check yes in <strong>Restrict Viewer Access</strong></li></ul><p>This is the rule that enforces signed URLs to access resources</p><ul><li>Leave the remaining defaults and click <strong>Create Distribution</strong></li></ul><h3 id="3-create-cloudfront-credentials">3. Create CloudFront credentials</h3><ul><li>Go to your AWS account (click your username in the top right corner)</li><li>Go to <strong>Security Credentials</strong></li><li>Expand <strong>CloudFront Key Pairs</strong></li><li>Click <strong>Create New Key Pair</strong></li><li>Download both the private and public key and store them safely</li><li>Note down the <strong>Access Key ID</strong>, you will need that for later</li></ul><h2 id="4-create-signed-urls">4. Create signed URLs</h2><p>I am using NodeJS for my application, so I made use of the NPM package <code>aws-cloudfront-sign</code>. Install it in your project directory.</p><pre><code class="lang-shell">npm install --save aws-cloudfront-sign
</code></pre><p>I will demonstrate the creation of a signed URL by implementing the <code>aws-cloudfront-sign</code> package in an Express route handler.</p><pre><code class="lang-javascript">import express from &apos;express&apos;
import cf from &apos;aws-cloudfront-sign&apos;

// AWS specific options
const AWS_ACCESS_KEY_ID = &apos;xxxxxxxxxx&apos;
const AWS_PRIVATE_KEY_PATH = &apos;./private-key.pem&apos;
const AWS_CLOUD_FRONT_URL = &apos;http://xxxxxxxx.cloudfront.net&apos;

// Initialize the Express application
const app = express()
app.listen(9000, () =&gt; console.log(&apos;Running on port 9000&apos;))

// Setup route handler
app.get(&apos;/images&apos;, createSignedUrl)

// Signed URL logic
function createSignedUrl (req, res) {
  const name = req.query.name
  const extension = req.query.ext
  const options = {
    keypairId: AWS_ACCESS_KEY_ID,
    privateKeyPath: AWS_PRIVATE_KEY_PATH,
    expireTime: new Date().getTime() + 45000
  }
  const url = `${AWS_CLOUD_FRONT_URL}/${name}.${extension}`
  const signedUrl = cf.getSignedUrl(url, options)
  res.json({ url: signedUrl })
}
</code></pre><p>You will now be able to create a signed URL for the <code>funny_cat.jpg</code> in your <em>private</em> S3 bucket. Try this:</p><pre><code class="lang-shell">curl http://localhost:9000/images?name=funny_cat&amp;ext=jpg
</code></pre><p>That will return a looong URL with query keys <em>Expires</em>, <em>Policy</em> and <em>Key-Pair-Id</em>. With this URL, you can go right ahead and fetch the resource. The URL will expire after 45 seconds as declared in our <code>options</code> object.</p><p>And well, that&apos;s it! &#x26A1;&#xFE0F;</p></main></article><div class="navigation__back"><a href="/">Go to main page</a></div><script src="frontend/dist/scripts/dist-vendor.min.js"></script><script src="frontend/dist/scripts/dist.min.js"></script></body></html>