<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="description" content="Developing my REST application (running on Express), I experienced a problem when trying to update nested object properties. Specifically, I was passing the req.body directly to the MongoDB $set operator. This did however lead to problems, as I accidentally removed properties."><meta name="keywords" content="development, programming, technology, IT, computer, algorithm, tutorial, guide, Docker, Node, Javascript, HTML, CSS"><meta name="author" content="Theodor Lindekaer"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><link rel="apple-touch-icon" sizes="57x57" href="img/apple-touch-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="img/apple-touch-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="img/apple-touch-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="img/apple-touch-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="img/apple-touch-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="img/apple-touch-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="img/apple-touch-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="img/apple-touch-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon-180x180.png"><link rel="icon" type="image/png" href="img/favicon-32x32.png" sizes="32x32"><link rel="icon" type="image/png" href="img/android-chrome-192x192.png" sizes="192x192"><link rel="icon" type="image/png" href="img/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/png" href="img/favicon-16x16.png" sizes="16x16"><link rel="manifest" href="img/manifest.json"><link rel="mask-icon" href="img/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="img/favicon.ico"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-TileImage" content="img/mstile-144x144.png"><meta name="msapplication-config" content="img/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Merriweather:300,+300italic|Lato:900|Source+Code+Pro" media="all"><link rel="stylesheet" href="assets/css/dist-vendor.min.css" type="text/css"><style>
body,code,html{border:0;vertical-align:baseline}code,html{margin:0;padding:0}body{font-size:100%}a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,canvas,caption,center,cite,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,i,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font-size:100%;vertical-align:baseline}article,aside,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}body{line-height:1;margin:3em auto 0;max-width:840px;padding:1em}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:none}table{border-collapse:collapse;border-spacing:0}*{box-sizing:border-box}html{font-family:'Merriweather',serif;font-weight:300;font-size:21px}@media (max-width:720px){html{font-size:18px}}h1,h2,h3,h4,h5,h6{font-family:'Lato',sans-serif;font-weight:700}h2,h3,h4,h5,h6{font-weight:900}@media (max-width:720px){body{padding:0 1.5em}}code{font-size:90%;font-family:'Source Code Pro'!important}.page-index{text-align:center}.front__logo{width:100%;max-width:500px}.front__links{margin-top:1em;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;list-style-type:none}@media (max-width:720px){.front__links{-webkit-box-orient:vertical;-webkit-box-direction:normal;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column}.front__links li{margin-top:1em}}.front__links a{padding:0 .4em}.front__article-selector{margin-top:2em;min-width:200px;max-width:100%;font-size:1em}.article{text-align:left;-webkit-transition:opacity .6s ease-in-out,-webkit-transform .6s ease-in-out;transition:transform .6s ease-in-out,opacity .6s ease-in-out;transition:transform .6s ease-in-out,opacity .6s ease-in-out,-webkit-transform .6s ease-in-out;opacity:0;-webkit-transform:translateY(40px);transform:translateY(40px)}.article.active{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}.article__title{font-size:3em;line-height:1.2em}.article h2{font-size:1.5em}.article h2,.article h3{margin-top:2em}.article p,.article ul{margin:1em 0;line-height:2em}.article ul{padding-left:1.5em}.article__meta{padding:1em 0 2em}.article__meta__author,.article__meta__date{margin-top:.5em;font-size:.8em;font-style:italic}.article pre{margin:2em 0!important}.article p code{padding:2px 4px;color:#c7254e;background-color:#f9f2f4;border-radius:4px}.media{margin:2em 0}.media__image{width:100%;opacity:1;-webkit-transition:opacity .3s;transition:opacity .3s}.media__image[data-src]{opacity:0}.media__caption{font-style:italic;font-size:80%;text-align:center;width:100%;padding:0 1.2em;color:gray}@media (max-width:720px){.media__caption{padding:none}}.media.group{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-box-align:start;-webkit-align-items:flex-start;-ms-flex-align:start;align-items:flex-start;-webkit-flex-flow:wrap;-ms-flex-flow:wrap;flex-flow:wrap}@media (max-width:720px){.media.group{-webkit-flex-flow:column;-ms-flex-flow:column;flex-flow:column}}.media.group .media__image{width:50%;padding:.4em}@media (max-width:720px){.media.group .media__image{width:100%}}[id*=map]{margin:3em 0;height:500px;border-radius:4px}@media (max-width:720px){[id*=map]{height:350px}}.navigation__back{text-align:center;margin:3em 0}
</style><title>Dynamically updating nested properties in MongoDB| Lindekaer</title></head><body class="page-article"><div class="navigation__back"><a href="/">Go back</a></div><div class="article"><h1 class="article__title">Dynamically updating nested properties in MongoDB</h1><div class="article__meta"><div class="article__meta__author">Theodor Lindekaer</div><div class="article__meta__date">March 3rd, 2016 (2 months ago)</div></div><div class="article__content"><p>Developing my REST application (running on Express), I experienced a problem when trying to update nested object properties. Specifically, I was passing the <code>req.body</code> directly to the MongoDB <code>$set</code> operator. This did however lead to problems, as I accidentally removed properties.</p><pre><code class="lang-javascript">// The user object in MongoDB (before the update)
var user = { 
  username: &apos;joe47&apos;,
  age: 42,
  address: {
    street: &apos;High Street&apos;,
    streetNumber: 109,
    zipCode: &apos;2020-90&apos;
  }
}

// The request body (sent as a PUT request to the Express app)
var body = {
  address: {
    streetNumber: 200
  }
}

// Updating the user
db.collections(&apos;users&apos;).update({ $set: req.body })

// The user object in MongoDB (after the update)
var user = { 
  username: &apos;joe47&apos;,
  age: 42,
  address: {
    streetNumber: 200,
  }
}
</code></pre><p>The set operation of the <code>address</code> property removed all other properties nested under <code>address</code>. In order to specifically update a single property in MongoDB, one has to use the string dot-notation.</p><pre><code class="lang-javascript">db.collections(&apos;users&apos;).update({ $set: { &apos;address.streetNumber&apos;: 200 } })
</code></pre><p>I therefore created a function to recursively loop through a nested JSON structure and construct a corresponding object in string dot-notation ready for a MongoDB update.</p><pre><code class="lang-javascript">function convertObject(obj) {
  var res = {};
  (function iterate(obj, parent) {
    for (var prop in obj) {
      if (obj.hasOwnProperty(prop)) {
        if (typeof obj[prop] === &apos;string&apos; 
          || typeof obj[prop] === &apos;number&apos; 
          || typeof obj[prop] === &apos;boolean&apos; 
          || Object.prototype.toString.call(obj[prop]) === &apos;[object Array]&apos; ) {
          if (parent) res[parent + &apos;.&apos; + prop] = obj[prop];
          else res[prop] = obj[prop];
        } else {
          if (parent) iterate(obj[prop], parent + &apos;.&apos; + prop);
          else iterate(obj[prop], prop);
        }
      }
    }
  })(obj)
  return res;
}
</code></pre><p>Here is an example:</p><pre><code class="lang-javascript">// Body before converting
var body = {
  address: {
    streetNumber: 200
  }
}

body = convertObject(body); // =&gt; { &apos;address.streetNumber&apos;: 200 }
</code></pre><p>It is now easy as cake to update a document by passing the <code>req.body</code>.</p><pre><code class="lang-javascript">db.collections(&apos;users&apos;).update({ $set: convertObject(req.body) })
</code></pre></div></div><div class="navigation__back"><a href="/">Go back</a></div><script src="assets/js/dist-vendor.min.js"></script><script src="assets/js/dist.min.js"></script></body></html>